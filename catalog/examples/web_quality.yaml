id: "packs/stacks/web-quality"
version: "1.0.0"
profile: "align"
spec_version: "1"
summary: "Core Web Vitals targets, performance budgets, image/font optimization, and a11y standards"
tags: ["web", "performance", "a11y", "quality", "paved-road"]
deps: []
scope:
  applies_to: ["frontend", "web"]
  includes:
    [
      "**/*.{ts,tsx,js,jsx,css,scss}",
      "app/**",
      "public/**",
      "lighthouserc.json",
      "lighthouse-budgets.json",
      "playwright.config.*",
    ]
rules:
  - id: "lcp-target"
    severity: "MUST"
    check:
      type: "command_runner"
      inputs:
        command: "pnpm exec lhci autorun --config=lighthouserc.json"
        timeout_ms: 120000
        expect_exit_code: 0
      evidence: "LCP exceeds 2.5s target (mobile p75)"
    autofix:
      hint: "Optimize hero image, reduce TTFB, or prioritize critical resources"

  - id: "use-next-image"
    severity: "MUST"
    check:
      type: "regex"
      inputs:
        include: ["app/**/*.{tsx,jsx}", "components/**/*.{tsx,jsx}"]
        pattern: "<img\\s+"
        allow: false
      evidence: "Raw <img> tag found, use next/image instead"
    autofix:
      hint: "Replace <img> with next/image and set width/height or fill + sizes"

  - id: "use-next-font"
    severity: "MUST"
    check:
      type: "regex"
      inputs:
        include: ["app/**/*.{ts,tsx}"]
        pattern: "from\\s+[\"']next/font"
        allow: true
      evidence: "Font not loaded via next/font"
    autofix:
      hint: "Use next/font/google or next/font/local instead of @font-face"

  - id: "a11y-eslint-required"
    severity: "MUST"
    check:
      type: "command_runner"
      inputs:
        command: 'jq -e ''.devDependencies["eslint-plugin-jsx-a11y"] != null or .dependencies["eslint-plugin-jsx-a11y"] != null'' package.json > /dev/null 2>&1'
        expect_exit_code: 0
      evidence: "Missing eslint-plugin-jsx-a11y"
    autofix:
      hint: "Add eslint-plugin-jsx-a11y and extend plugin:jsx-a11y/recommended"

  - id: "a11y-critical-violations"
    severity: "MUST"
    check:
      type: "command_runner"
      inputs:
        command: "pnpm exec playwright test --grep @a11y"
        timeout_ms: 60000
        expect_exit_code: 0
      evidence: "Critical a11y violations found"
    autofix:
      hint: "Fix WCAG 2.0 AA violations reported by axe-core"

integrity:
  algo: "jcs-sha256"
  value: "982ecc92cb0f7869203b32dd8549f5c0507f993697eadfe54f51f08dc67bba75"

notes: |
  SLO targets (mobile p75):
  - LCP: ≤ 2.5s
  - INP: ≤ 200ms
  - CLS: ≤ 0.10
  - TTFB: ≤ 800ms

  Performance budgets (gzipped, initial route):
  - JavaScript: ≤ 150 KB
  - CSS: ≤ 50 KB
  - Image: ≤ 200 KB (single above-fold)
  - Font: ≤ 150 KB (sum of first-paint)

guidance: |
  # Web Quality Guide

  Owns measurable UX targets and enforcement. App behavior lives in nextjs-app-router.
  Deploy/runtime details live in vercel-deployments.

  ## Core Web Vitals SLOs

  Failing SLOs blocks release to Production.

  ## Images

  - Use next/image exclusively
  - Always set stable sizing
  - Prefer AVIF/WebP
  - Large media behind click-to-load

  ## Fonts

  - Use next/font only
  - Subset and keep to ≤ 2 families, ≤ 4 weights
  - Avoid layout shift

  ## Scripts and third-party

  - Ban synchronous/blocking tags
  - Load analytics with lightweight tag
  - Each script must declare: purpose, owner, size impact, removal plan

  ## Accessibility

  - ESLint plugin:jsx-a11y/recommended required
  - Keyboard support for all interactive components
  - Color contrast WCAG AA minimum
  - Playwright + axe smoke tests
